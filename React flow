import { createContext, useState, useEffect } from "react";
import { setupFetchInterceptor } from "./fetchInterceptor";

export const AuthContext = createContext();

export const AuthProvider = ({ children }) => {
  const [jwt, setJwt] = useState(null);
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [sessionExpireAt, setSessionExpireAt] = useState(null);

  // Fetch AM Token
  const getAmToken = async () => {
    const res = await fetch("/api/sso/get-am-token");
    const data = await res.json();
    return data.amToken;
  };

  // Get user info using AM token
  const getUserInfo = async (amToken) => {
    const res = await fetch("/api/sso/user-info", {
      headers: { Authorization: `Bearer ${amToken}` },
    });
    return res.json();
  };

  // Convert AM token → JWT
  const getJwt = async (amToken) => {
    const res = await fetch("/api/sso/convert-token", {
      method: "POST",
      headers: { Authorization: `Bearer ${amToken}` },
    });
    return res.json();
  };

  // SESSION WATCHER
  const startSessionWatcher = (exp) => {
    setSessionExpireAt(exp);

    const now = Date.now();
    const expireTime = exp * 1000;

    const timeout = expireTime - now - 10000; // 10 sec before expiry

    setTimeout(() => {
      alert("Your session expired. Refresh to login again.");
      setJwt(null);
      setUser(null);
    }, timeout);
  };

  // MAIN SSO FLOW
  const initLoginFlow = async () => {
    try {
      const amToken = await getAmToken();
      const userInfo = await getUserInfo(amToken);
      const jwtData = await getJwt(amToken);

      setUser(userInfo);
      setJwt(jwtData.jwt);

      setupFetchInterceptor(jwtData.jwt);

      startSessionWatcher(jwtData.exp);

    } catch (err) {
      console.error("SSO Login failed → ", err);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    initLoginFlow();
  }, []);

  return (
    <AuthContext.Provider value={{ jwt, user, loading }}>
      {children}
    </AuthContext.Provider>
  );
};
